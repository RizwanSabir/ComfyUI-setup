#!/bin/bash

set -e

echo "===== Starting Setup ====="

#############################################
# Variables
#############################################

CONDA_DIR="$PWD/miniconda"
ENV_NAME="comfyui_env"

#############################################
# Install Miniconda if Missing
#############################################

if [ ! -d "$CONDA_DIR/bin" ]; then
    echo "Installing Miniconda..."

    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh

    bash miniconda.sh -b -p "$CONDA_DIR"

    rm miniconda.sh
else
    echo "Miniconda already installed âœ”"
fi

#############################################
# Load Conda
#############################################

export PATH="$CONDA_DIR/bin:$PATH"

if [ -f "$CONDA_DIR/etc/profile.d/conda.sh" ]; then
    source "$CONDA_DIR/etc/profile.d/conda.sh"
else
    echo "Conda initialization file missing"
    exit 1
fi

#############################################
# Accept Conda TOS Automatically
#############################################

echo "Accepting Conda Terms of Service..."

$CONDA_DIR/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main || true

$CONDA_DIR/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r || true

#############################################
# Verify Conda
#############################################

if ! command -v conda >/dev/null 2>&1; then
    echo "Conda setup failed"
    exit 1
fi

echo "Conda working âœ”"

#############################################
# Create Environment
#############################################

if conda env list | grep -q "$ENV_NAME"; then
    echo "Environment exists â†’ Activating"
else
    echo "Creating environment with Python 3.12"
    conda create -n $ENV_NAME python=3.12 -y
fi

echo "Activating environment..."
source activate $ENV_NAME || conda activate $ENV_NAME

#############################################
# Clone ComfyUI
#############################################

if [ ! -d "ComfyUI" ]; then
    git clone https://github.com/Comfy-Org/ComfyUI.git
fi

cd ComfyUI

#############################################
# Install Dependencies
#############################################

echo "Installing Python dependencies..."

pip install --upgrade pip
pip install -r requirements.txt

echo "===== Setup Complete ðŸš€ ====="
