#!/bin/bash

set -e

echo "===== Starting Setup ====="

#############################################
# Check Conda Installation
#############################################

if command -v conda >/dev/null 2>&1; then
    echo "Conda is already installed"
else
    echo "Conda not found. Installing Miniconda locally..."

    CONDA_DIR="$PWD/miniconda"

    if [ ! -d "$CONDA_DIR" ]; then
        mkdir -p "$CONDA_DIR"

        # Download Miniconda
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh

        bash miniconda.sh -b -p "$CONDA_DIR"

        rm miniconda.sh
    fi

    # Initialize conda in current shell
    export PATH="$CONDA_DIR/bin:$PATH"
    source "$CONDA_DIR/etc/profile.d/conda.sh" || true

    echo "Conda installed locally"
fi

#############################################
# Load conda into shell if exists globally
#############################################

if [ -f "$HOME/.bashrc" ]; then
    source "$HOME/.bashrc" || true
fi

if command -v conda >/dev/null 2>&1; then
    echo "Conda available ✔"
else
    echo "Conda not available even after installation"
    exit 1
fi

#############################################
# Create or Use Conda Environment
#############################################

ENV_NAME="comfyui_env"

if conda env list | grep -q "$ENV_NAME"; then
    echo "Conda environment already exists → Activating"
else
    echo "Creating conda environment with Python 3.12"
    conda create -n $ENV_NAME python=3.12 -y
fi

echo "Activating environment..."
conda activate $ENV_NAME || source activate $ENV_NAME

#############################################
# Clone Repositories
#############################################

if [ ! -d "ComfyUI-setup" ]; then
    echo "Cloning ComfyUI-setup..."
    git clone https://github.com/RizwanSabir/ComfyUI-setup.git
else
    echo "ComfyUI-setup already exists."
fi

if [ ! -d "ComfyUI" ]; then
    echo "Cloning ComfyUI..."
    git clone https://github.com/Comfy-Org/ComfyUI.git
else
    echo "ComfyUI already exists."
fi

#############################################
# Install Dependencies
#############################################

cd ComfyUI

echo "Installing Python dependencies..."
pip install --upgrade pip
pip install -r requirements.txt

echo "===== Setup Complete ====="
